<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lily's Unicorns - Level Map</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #87CEEB 0%, #98E4FF 50%, #87CEEB 100%);
            font-family: monospace;
            color: #333;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .map-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .map-canvas {
            position: relative;
            width: 900px;
            height: 700px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .diamond {
            position: absolute;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            transform: rotate(45deg);
            border: 3px solid #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .diamond:hover {
            transform: rotate(45deg) scale(1.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            background: linear-gradient(45deg, #FFE55C, #FFB347);
        }
        
        .diamond.completed {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }
        
        .diamond.locked {
            background: linear-gradient(45deg, #999, #666);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .diamond.current {
            background: linear-gradient(45deg, #ff6b6b, #e74c3c);
            animation: pulse 2s infinite;
        }
        
        .diamond.selected {
            border: 4px solid #4A90E2;
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.6);
        }
        
        @keyframes pulse {
            0%, 100% { transform: rotate(45deg) scale(1); }
            50% { transform: rotate(45deg) scale(1.1); }
        }
        
        .diamond-label {
            position: absolute;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            transform: rotate(-45deg);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        
        .connection-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.3));
            z-index: 1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 20;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(45deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            padding: 10px 20px;
            font-family: monospace;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 20;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .level-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .level-info.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .level-info.persistent {
            opacity: 1;
            pointer-events: all;
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid #4A90E2;
        }
        
        .mobile-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #87CEEB 0%, #98E4FF 50%, #87CEEB 100%);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .mobile-warning-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            font-family: monospace;
        }
        
        @media (max-width: 768px) {
            .mobile-warning {
                display: flex;
            }
            .map-container {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="mobile-warning">
        <div class="mobile-warning-content">
            <div style="font-size: 3em; margin: 20px 0;">ü¶Ñ</div>
            <h2 style="color: #4A90E2;">Computer Required</h2>
            <p>Level selection is designed for desktop use.</p>
            <div>
                <a href="index.html" style="color: #4A90E2; text-decoration: none; font-weight: bold;">‚Üê Back to Game</a>
            </div>
        </div>
    </div>

    <div class="map-container">
        <div class="title">ü¶Ñ Level Map üåà</div>
        
        <button class="back-button" onclick="goBack()">‚Üê Back to Game</button>
        
        <button class="back-button" onclick="resetProgress()" style="top: 20px; right: 20px; left: auto; background: linear-gradient(45deg, #e74c3c, #c0392b);">üîÑ Reset Progress</button>
        
        <div class="map-canvas" id="mapCanvas">
            <!-- Diamonds and connections will be generated by JavaScript -->
        </div>
        
        <div class="level-info" id="levelInfo">
            <h3 id="levelTitle">Level 1</h3>
            <p id="levelDescription">The beginning of your magical journey!</p>
            <button onclick="playLevel()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">Play Level</button>
        </div>
    </div>

    <script>
        // Progress tracking system (shared with game.js)
        class ProgressManager {
            static getProgress() {
                try {
                    const progress = localStorage.getItem('lily_unicorns_progress');
                    return progress ? JSON.parse(progress) : { completedLevels: [], currentLevel: 1 };
                } catch (error) {
                    console.warn('Failed to load progress:', error);
                    return { completedLevels: [], currentLevel: 1 };
                }
            }
            
            static saveProgress(progress) {
                try {
                    localStorage.setItem('lily_unicorns_progress', JSON.stringify(progress));
                } catch (error) {
                    console.warn('Failed to save progress:', error);
                }
            }
            
            static getCurrentLevel() {
                return this.getProgress().currentLevel;
            }
            
            static getCompletedLevels() {
                return this.getProgress().completedLevels;
            }
            
            static isLevelCompleted(level) {
                return this.getCompletedLevels().includes(level);
            }
            
            static resetProgress() {
                this.saveProgress({ completedLevels: [], currentLevel: 1 });
            }
        }

        class LevelMap {
            constructor() {
                this.mapCanvas = document.getElementById('mapCanvas');
                this.currentLevel = ProgressManager.getCurrentLevel();
                this.completedLevels = ProgressManager.getCompletedLevels();
                this.maxLevels = 12; // Will be detected later
                this.selectedLevel = this.currentLevel;
                this.levelPositions = {};
                this.connections = [];
                
                this.init();
            }
            
            async init() {
                await this.detectMaxLevels();
                this.generateLevelPositions();
                this.createConnections();
                this.renderMap();
                this.setupEventListeners();
            }
            
            async detectMaxLevels() {
                // Try to detect available levels
                let levelNumber = 1;
                while (levelNumber <= 20) { // Extended detection range
                    try {
                        const response = await fetch(`levels/level${levelNumber}.json`, {
                            cache: 'no-store',
                            headers: { 'Cache-Control': 'no-cache' }
                        });
                        
                        if (response.ok) {
                            levelNumber++;
                        } else {
                            break;
                        }
                    } catch (error) {
                        // Check embedded data as fallback
                        if (typeof LEVEL_DATA !== 'undefined' && LEVEL_DATA[levelNumber]) {
                            levelNumber++;
                        } else {
                            break;
                        }
                    }
                }
                
                this.maxLevels = Math.max(levelNumber - 1, 4); // Minimum 4 levels
            }
            
            generateLevelPositions() {
                const centerX = 450;
                const centerY = 350;
                const baseRadius = 120;
                
                // Level 1 at center
                this.levelPositions[1] = { x: centerX, y: centerY };
                
                // Calculate positions based on connection pattern
                for (let level = 2; level <= this.maxLevels; level++) {
                    const parent = this.getParentLevel(level);
                    const parentPos = this.levelPositions[parent];
                    
                    if (parentPos) {
                        const childIndex = this.getChildIndex(level, parent);
                        const angle = this.getChildAngle(childIndex, parent);
                        const distance = this.getDistanceFromCenter(level);
                        
                        this.levelPositions[level] = {
                            x: parentPos.x + Math.cos(angle) * distance,
                            y: parentPos.y + Math.sin(angle) * distance
                        };
                    }
                }
            }
            
            getParentLevel(level) {
                if (level <= 10) return 1;
                
                // Level 11+ connects to level (level-10)
                // e.g., level 11 -> level 1, level 12 -> level 2, etc.
                const baseLevel = ((level - 11) % 10) + 1;
                return Math.min(baseLevel, this.maxLevels);
            }
            
            getChildIndex(level, parent) {
                if (parent === 1 && level <= 10) {
                    return level - 2; // levels 2-10 are children 0-8 of level 1
                }
                
                // For higher levels, calculate based on the pattern
                return Math.floor((level - 11) / 10);
            }
            
            getChildAngle(childIndex, parent) {
                if (parent === 1) {
                    // 9 directions from center (levels 2-10)
                    return (childIndex * Math.PI * 2 / 9) - (Math.PI / 2);
                }
                
                // For other parents, spread children around them
                return (childIndex * Math.PI * 2 / 3) - (Math.PI / 2);
            }
            
            getDistanceFromCenter(level) {
                if (level <= 10) return 120;
                
                const generation = Math.floor((level - 11) / 10) + 1;
                return 120 + (generation * 100);
            }
            
            createConnections() {
                this.connections = [];
                
                for (let level = 2; level <= this.maxLevels; level++) {
                    const parent = this.getParentLevel(level);
                    if (this.levelPositions[parent] && this.levelPositions[level]) {
                        this.connections.push({
                            from: parent,
                            to: level,
                            fromPos: this.levelPositions[parent],
                            toPos: this.levelPositions[level]
                        });
                    }
                }
            }
            
            renderMap() {
                // Clear existing content
                this.mapCanvas.innerHTML = '';
                
                // Render connections first (behind diamonds)
                this.connections.forEach(conn => {
                    this.renderConnection(conn);
                });
                
                // Render diamonds
                for (let level = 1; level <= this.maxLevels; level++) {
                    if (this.levelPositions[level]) {
                        this.renderDiamond(level, this.levelPositions[level]);
                    }
                }
            }
            
            renderConnection(connection) {
                const line = document.createElement('div');
                line.className = 'connection-line';
                
                const dx = connection.toPos.x - connection.fromPos.x;
                const dy = connection.toPos.y - connection.fromPos.y;
                const length = Math.sqrt(dx * dx + dy * dy) - 60; // Subtract diamond size
                const angle = Math.atan2(dy, dx);
                
                line.style.width = `${length}px`;
                line.style.left = `${connection.fromPos.x + Math.cos(angle) * 30}px`;
                line.style.top = `${connection.fromPos.y + Math.sin(angle) * 30}px`;
                line.style.transform = `rotate(${angle}rad)`;
                line.style.transformOrigin = 'left center';
                
                this.mapCanvas.appendChild(line);
            }
            
            renderDiamond(level, position) {
                const diamond = document.createElement('div');
                diamond.className = 'diamond';
                diamond.style.left = `${position.x - 30}px`;
                diamond.style.top = `${position.y - 30}px`;
                diamond.dataset.level = level;
                
                // Add status classes based on actual progress
                const isCompleted = this.completedLevels.includes(level);
                const isLocked = level > this.currentLevel;
                
                if (level === this.currentLevel && !isCompleted) {
                    diamond.classList.add('current');
                } else if (isCompleted) {
                    diamond.classList.add('completed');
                } else if (isLocked) {
                    diamond.classList.add('locked');
                }
                
                // Add label
                const label = document.createElement('div');
                label.className = 'diamond-label';
                label.textContent = level;
                diamond.appendChild(label);
                
                // Add click handler - either play level directly or show info
                diamond.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (isLocked) {
                        this.showLevelInfo(level, true);
                        return;
                    }
                    
                    // Double-click or already selected level plays immediately
                    if (this.selectedLevel === level) {
                        this.playSelectedLevel();
                    } else {
                        this.selectLevel(level, true);
                    }
                });
                
                // Hover behavior for preview only
                diamond.addEventListener('mouseenter', () => {
                    if (this.selectedLevel !== level) {
                        this.showLevelInfo(level, false);
                    }
                });
                
                diamond.addEventListener('mouseleave', () => {
                    if (!this.levelInfoPersistent) {
                        this.hideLevelInfo();
                    }
                });
                
                this.mapCanvas.appendChild(diamond);
            }
            
            selectLevel(level, persistent = false) {
                this.selectedLevel = level;
                this.showLevelInfo(level, persistent);
                
                // Update diamond visual selection
                this.updateDiamondSelection();
            }
            
            showLevelInfo(level, persistent = false) {
                const levelInfo = document.getElementById('levelInfo');
                const levelTitle = document.getElementById('levelTitle');
                const levelDescription = document.getElementById('levelDescription');
                
                levelTitle.textContent = `Level ${level}`;
                levelDescription.textContent = this.getLevelDescription(level);
                
                // Update play button based on level status
                const playButton = levelInfo.querySelector('button');
                const isCompleted = this.completedLevels.includes(level);
                const isLocked = level > this.currentLevel;
                
                if (isLocked) {
                    playButton.textContent = 'Locked Level';
                    playButton.style.background = '#999';
                    playButton.style.cursor = 'not-allowed';
                    playButton.onclick = null;
                } else if (isCompleted) {
                    playButton.textContent = 'Replay Level';
                    playButton.style.background = '#4CAF50';
                    playButton.style.cursor = 'pointer';
                    playButton.onclick = () => this.playSelectedLevel();
                } else if (level === this.currentLevel) {
                    playButton.textContent = 'Continue Level';
                    playButton.style.background = '#ff6b6b';
                    playButton.style.cursor = 'pointer';
                    playButton.onclick = () => this.playSelectedLevel();
                } else {
                    playButton.textContent = 'Play Level';
                    playButton.style.background = '#4CAF50';
                    playButton.style.cursor = 'pointer';
                    playButton.onclick = () => this.playSelectedLevel();
                }
                
                levelInfo.classList.add('show');
                if (persistent) {
                    levelInfo.classList.add('persistent');
                    this.levelInfoPersistent = true;
                } else {
                    levelInfo.classList.remove('persistent');
                    this.levelInfoPersistent = false;
                }
                
                this.selectedLevel = level;
            }
            
            hideLevelInfo() {
                const levelInfo = document.getElementById('levelInfo');
                levelInfo.classList.remove('show', 'persistent');
                this.levelInfoPersistent = false;
            }
            
            updateDiamondSelection() {
                // Remove previous selection highlights
                this.mapCanvas.querySelectorAll('.diamond').forEach(diamond => {
                    diamond.classList.remove('selected');
                });
                
                // Add selection highlight to current diamond
                const selectedDiamond = this.mapCanvas.querySelector(`[data-level="${this.selectedLevel}"]`);
                if (selectedDiamond) {
                    selectedDiamond.classList.add('selected');
                }
            }
            
            playSelectedLevel() {
                if (this.selectedLevel && this.selectedLevel <= this.currentLevel) {
                    window.location.href = `index.html?level=${this.selectedLevel}`;
                }
            }
            
            getLevelDescription(level) {
                const descriptions = {
                    1: "The beginning of your magical journey!",
                    2: "Navigate through the first challenges.",
                    3: "Trees and platforms await you.",
                    4: "Maze Runner - Find your way through!",
                    5: "Jumping puzzles and precision timing.",
                    6: "Advanced platforming challenges.",
                    7: "Dangerous swamps and careful navigation.",
                    8: "Complex multi-level structures.",
                    9: "Speed and agility required.",
                    10: "Master level precision needed."
                };
                
                return descriptions[level] || `Challenge level ${level} - Test your skills!`;
            }
            
            setupEventListeners() {
                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.hideLevelInfo();
                    }
                });
                
                // Click outside to close level info
                document.addEventListener('click', (e) => {
                    const levelInfo = document.getElementById('levelInfo');
                    const clickedDiamond = e.target.closest('.diamond');
                    
                    if (!levelInfo.contains(e.target) && !clickedDiamond) {
                        this.hideLevelInfo();
                    }
                });
                
                // Prevent level info from closing when clicking inside it
                document.getElementById('levelInfo').addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        }
        
        function playLevel() {
            const map = window.levelMap;
            if (map && map.selectedLevel) {
                map.playSelectedLevel();
            }
        }
        
        function goBack() {
            if (document.referrer && document.referrer.includes('lily_unicorns')) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }
        
        function resetProgress() {
            if (confirm('Are you sure you want to reset all progress? This will clear all completed levels and start from Level 1.')) {
                ProgressManager.resetProgress();
                // Reload the page to show updated progress
                window.location.reload();
            }
        }
        
        // Initialize the level map
        window.levelMap = new LevelMap();
    </script>
</body>
</html>